SHELL = /bin/bash
MD_FILES = $(shell find . -name "*.md" \( -not -path "./docs/*" \) -printf '%P\n')
MD_OUT_FILES = $(addprefix docs/, $(MD_FILES))
PRIVATE_FILES = $(shell find Private)

# we want the freedom to have a traditional git ignore
# so this is just stuff that we don't want to check in
define GIT_IGNORED
Makefile
private.zip
Private
endef

define BLANK_LINES




endef

export BLANK_LINES

define MD_HEADER
---
title:  "$(basename $(notdir $<))"
---

<!-- DO NOT EDIT THIS FILE in docs.  It is autogenerated from the non-doc version -->

### Contents

endef

all: private.zip.gpg .git/info/exclude output_mds .profMakeBackup
.PHONY : all hideprivate decryptprivate output_mds 

# rules for decrypting/encrypting the Private Directory

%.gpg : %
	rm -f $<.gpg
	gpg --batch --passphrase-file ~/Private/dotfiles/passphrase --symmetric $<

decryptprivate :
	gpg -o private.zip --batch --passphrase-file ~/Private/dotfiles/passphrase --decrypt private.zip.gpg
	unzip private.zip

hideprivate : private.zip.gpg
	rm -r Private/* private.zip

private.zip : $(PRIVATE_FILES)
	zip -r private.zip Private

# rules for symlinking all the stuff in private into the other directories
# but preventing those simlinks from being checked into git

.git/info/exclude : $(PRIVATE_FILES)
# this does the recreate
	find . -type l -delete
	cp -Rsn $(CURDIR)/Private/* .
# this prevents the links from being used in git
	$(file > .git/info/exclude,$(GIT_IGNORED))
	find . -type l -printf '%P\n' >> .git/info/exclude

# rules for moving markdown
#
# google pages looks in the docs directory for files to display we
# copy over any md files into a corresponding directory there on the
# way, we add a TOC and a jekyll header

output_mds: $(MD_OUT_FILES) docs/index.md

docs/%.md : %.md
	mkdir -p docs/$(dir $<)
	$(file > /tmp/myheader,$(MD_HEADER))
	$(file > /tmp/blanks,$(BLANK_LINES))
	markdown-toc $< > /tmp/mytoc
	cat /tmp/myheader /tmp/mytoc /tmp/blanks $< > docs/$<

docs/index.md : $(MD_OUT_FILES)
	$(file > docs/index.md,$(BLANK_LINES))
	find . -name "*.md" \( -not -path "./docs/*" \) -printf '%P\n' > /tmp/myindex
	awk -F/ '{print NF " " substr($$0, 1, length($$0)-3)}' /tmp/myindex | sort -n | awk '{print "* [" $$2 "](" $$2 ")"}' >> docs/index.md
# sed -i -e "s|\(.*\)\.md|*[\1](\1)|" docs/index.md

# we don't want to check the makefile in as Makefile because it might
# be confused for a real Makefile.  But it really should be checked
# into the repo
.profMakeBackup: Makefile
	cp Makefile .profMakeBackup
